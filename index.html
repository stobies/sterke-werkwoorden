<!DOCTYPE html>
<html manifest="app.appcache">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="192x192" href="favicon.png">
  <link rel="icon" type="image/png" href="favicon.png" />
  <title>Sterke Werkwoorden</title>
  <script src="ow.js"></script>
  <script src="watleuk.js"></script>
  <script>
  let ow;
  // when difficulty > 1 we may have multiple blanks per round
  // this array holds the indices the user needs to fill
  let blanksIndices = [];
  let correctThisRound = 0;
  // track if a specific blank has had an incorrect attempt
  let fieldHadError = {};
  let total;
  let totalOk = 0;
  let totalError = 0;
  let currentLanguage = 'en';
  let difficulty = 1; // 1 (easy) .. 4 (hard)
  const AVAILABLE_LANGUAGES = ['en', 'de'];
  const LANGUAGE_NAMES = {'en': 'English', 'de': 'Deutsch'};
  
  const WORDLISTS = {
      'complete': { name: 'Heele lijst', data: OwList },
      'watleuk': { name: 'Wat leuk', data: WatLeukList }
  };
  let selectedList = null;
  
  function getTranslation(translationObj) {
      if (typeof translationObj === 'string') {
          // Old format - just a string
          return translationObj;
      }
      // New format - dictionary with languages
      if (translationObj[currentLanguage]) {
          return translationObj[currentLanguage];
      }
      // Fallback to English
      return translationObj['en'] || JSON.stringify(translationObj);
  }
  
  function detectBrowserLanguage() {
      const browserLang = navigator.language || navigator.userLanguage || 'en';
      const langCode = browserLang.split('-')[0].toLowerCase();
      return AVAILABLE_LANGUAGES.includes(langCode) ? langCode : 'en';
  }
  
  function setLanguage(lang) {
      if (AVAILABLE_LANGUAGES.includes(lang)) {
          currentLanguage = lang;
          localStorage.language = lang;
          updateLanguageDisplay();
      }
  }
  
  function updateLanguageDisplay() {
      // Update language buttons
      AVAILABLE_LANGUAGES.forEach(lang => {
          const btn = document.getElementById(`lang-${lang}`);
          if (btn) {
              btn.classList.toggle('active', lang === currentLanguage);
          }
      });
      // Update game display if game is running
      if (ow) {
          document.querySelector('.meaning').innerHTML = getTranslation(ow[4]);
      }
  }
  function next() {
      if (!OwList.length) {
          const row = document.querySelector('.row');
          row.innerHTML = `Done! ${totalOk} / ${total}`;
          row.classList.add('results');
          document.querySelector('.meaning').innerHTML = '';
          return;
      }
      const ix = Math.floor(Math.random() * OwList.length);
      ow = OwList[ix];
      OwList.splice(ix, 1);

      // prepare blanks based on difficulty
      blanksIndices = [];
      correctThisRound = 0;
      fieldHadError = {};
      // choose "difficulty" distinct indices from 0..3
      const indices = [0,1,2,3];
      for (let i = 0; i < difficulty; i++) {
          const j = Math.floor(Math.random() * indices.length);
          blanksIndices.push(indices.splice(j,1)[0]);
      }
      ow.forEach((part, ix) => {
          if (ix > 3) {
              document.querySelector('.meaning').innerHTML = getTranslation(part);
              return;
          }
          const txt = document.getElementById(`txt${ix}`);
          // reset styling
          txt.classList.remove('ok','error');
          if (blanksIndices.includes(ix)) {
              txt.value = '';
              txt.readOnly = false;
          } else {
              txt.value = part;
              txt.readOnly = true;
          }
          // focus first blank
          if (ix === blanksIndices[0]) {
              txt.focus();
          }
      });
  }
  function onInput(e) {
      // reveal when user types '?' in any blank field
      if (e.target.value.indexOf('?') >= 0) {
          revealAnswer(parseInt(e.target.id.replace('txt',''),10));
          return;
      }
      if (!localStorage.submitWithReturn) {
          const idx = parseInt(e.target.id.replace('txt',''),10);
          if (blanksIndices.includes(idx) && e.target.value === ow[idx]) {
              markCorrect(idx);
          }
      }
  }
  function onKeyDown(e) {
      if (localStorage.submitWithReturn && (e.keyCode || e.which) === 13) {
          const idx = parseInt(e.target.id.replace('txt',''),10);
          if (!blanksIndices.includes(idx)) return;
          const incorrect = e.target.value !== ow[idx];
          if (incorrect) {
              fieldHadError[idx] = true;
              const txt = document.getElementById(`txt${idx}`);
              txt.classList.add('error');
              setTimeout(() => txt.classList.remove('error'), 200);
          } else {
              markCorrect(idx);
          }
      }
  }
  // mark a specific blank as correct and advance if all done
  function markCorrect(idx) {
      const txt = document.getElementById(`txt${idx}`);
      txt.classList.add('ok');
      txt.readOnly = true;
      correctThisRound++;
      if (fieldHadError[idx]) {
          totalError++;
      } else {
          totalOk++;
      }
      showProgress();
      // if all blanks filled advance
      if (correctThisRound >= blanksIndices.length) {
          setTimeout(next, 300);
      }
  }

  function revealAnswer(idx) {
      const txt = document.getElementById(`txt${idx}`);
      txt.classList.add('error');
      txt.value = ow[idx];
      txt.readOnly = true;
      totalError++;
      showProgress();
      // if this was one of the blanks, count it as done
      if (blanksIndices.includes(idx)) {
          correctThisRound++;
          if (correctThisRound >= blanksIndices.length) {
              setTimeout(next, 1000);
          }
      }
  }
  function showProgress() {
      document.getElementById('progress-ok').style.width = (totalOk / total * 100) + '%';
      document.getElementById('progress-error').style.width = (totalError / total * 100) + '%';
  }
  function init() {
      // Initialize language
      currentLanguage = localStorage.language || detectBrowserLanguage();
      
      // Setup language buttons
      document.querySelectorAll('[id^="lang-"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const lang = e.target.id.replace('lang-', '');
              setLanguage(lang);
          });
      });
      updateLanguageDisplay();
      
      document.querySelectorAll('input').forEach(input => {
          input.addEventListener('input', onInput);
          input.addEventListener('keydown', onKeyDown);
      });
      const slider = document.getElementById('difficulty-slider');
      if (slider) {
          slider.value = localStorage.difficulty || 1;
          difficulty = parseInt(slider.value,10);
          slider.addEventListener('input', (e) => {
              difficulty = parseInt(e.target.value,10);
              localStorage.difficulty = difficulty;
              updateDifficultyDisplay();
          });
          updateDifficultyDisplay();
      }
      document.querySelectorAll('.submit-with-return').forEach(check => {
          check.addEventListener('click', () => {
              if (localStorage.submitWithReturn) {
                  delete localStorage.submitWithReturn;
              } else {
                  localStorage.submitWithReturn = true;
              }
              showSubmitWithReturn();
          });
      });
      showSubmitWithReturn();
      showStartPage();
  }
  function showStartPage() {
      document.querySelector('.start-page').style.display = 'flex';
      document.querySelector('.game-area').style.display = 'none';
  }

  function updateDifficultyDisplay() {
      const disp = document.getElementById('difficulty-value');
      if (disp) {
          // map 1..4 to descriptive Dutch words or numbers
          const labels = ['1 (gemakkelijk)', '2', '3', '4 (moeilijk)'];
          disp.textContent = labels[difficulty-1] || difficulty;
      }
  }
  function startGame() {
      const listKey = document.getElementById('wordlist-select').value;
      // read difficulty again in case it changed on start page
      difficulty = parseInt(document.getElementById('difficulty-slider').value,10) || 1;
      localStorage.difficulty = difficulty;
      selectedList = WORDLISTS[listKey].data.map(item => [...item]);
      total = selectedList.length;
      totalOk = 0;
      totalError = 0;
      document.getElementById('progress-ok').style.width = '0%';
      document.getElementById('progress-error').style.width = '0%';
      document.querySelector('.start-page').style.display = 'none';
      document.querySelector('.game-area').style.display = 'block';
      OwList = selectedList;
      next();
  }
  function showSubmitWithReturn() {
      document.querySelector('.submit-with-return').classList.toggle('active', !!localStorage.submitWithReturn);
  }
  setTimeout(init);
  </script>
  <style>
  body, html {
      height: 100%;
      min-height: 100%;
  }
  body {
      font-family: -apple-system, Helvetica, Arial;
      padding: 0;
      margin: 0;
      font-size: 30px;
      background: #282B33;
  }
  .row {
      display: flex;
      justify-content: space-between;
      padding-top: 2%;
  }
  .row.results {
      color: #ABB2BE;
  }
  @media screen and (max-width: 800px) {
      .row {
          flex-direction: column;
          justify-content: flex-start;
      }
  }
  .results {
      padding: 20px;
      justify-content: center;
  }
  .item {
      padding: 20px;
      position: relative;
  }
  label {
      display: block;
      padding: 4px 8px;
      font-size: 10px;
      color: #5A606A;
  }
  input {
      display: block;
      width: 90%;
      font-size: 30px;
      padding: 4px 8px;
      transition: background-color 300ms linear, border-color 300ms linear;
      outline: none;
      border-radius: 2px;
      border: 2px solid #555C66;
      background: #282B33;
      color: #ABB2BE;
  }
  input[readOnly] {
      border-color: transparent;
  }
  input.ok {
      background-color: #242E2E;
      border-color: #74C892;
  }
  input.error {
      background-color: #312426;
      border-color: #FF644E;
  }
  .progress {
      display: flex;
  }
  #progress-ok, #progress-error {
      height: 2px;
      width: 0;
      transition: width 100ms linear;
  }
  #progress-ok {
      background: #54F176;
      box-shadow: 0 0 3px #242E2E;
  }
  #progress-error {
      background: #FF644E;
      box-shadow: 0 0 3px #312426;
  }
  .meaning {
      color: #5A606A;
      text-align: center;
      padding: 30px 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
  }
  .footer {
      /* improved contrast for help text */
      color: #ABB2BE;
      font-size: 12px;
      text-align: center;
      width: 100%;
      padding: 10px 0;
      /* increase opacity for readability */
      opacity: 0.6;
  }
  .submit-with-return {
      position: fixed;
      right: 10px;
      bottom: 10px;
      color: #373A43;
      font-family: monospace;
      cursor: pointer;
      font-size: 14px;
      transition: color 100ms ease-out;
  }
  .submit-with-return.active, .submit-with-return.active:hover {
      color: #555C66;
  }
  .submit-with-return:hover {
      color: #3d414b;
  }
  .language-selector {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
  }
  .lang-btn {
      padding: 6px 12px;
      background: #3d414b;
      color: #5A606A;
      border: 1px solid #555C66;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: -apple-system, Helvetica, Arial;
      transition: all 100ms ease-out;
  }
  .lang-btn:hover {
      background: #444a54;
      color: #6b7280;
  }
  .lang-btn.active {
      background: #54F176;
      color: #282B33;
      border-color: #54F176;
  }
  .start-page {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
  }
  .start-content {
      text-align: center;
  }
  .start-content h1 {
      color: #ABB2BE;
      margin-bottom: 30px;
  }
  .list-selector {
      margin-bottom: 30px;
  }
  .list-selector label {
      color: #5A606A;
      font-size: 16px;
      display: block;
      margin-bottom: 10px;
  }
  .list-selector select {
      font-size: 18px;
      padding: 10px 20px;
      background: #3d414b;
      color: #ABB2BE;
      border: 1px solid #555C66;
      border-radius: 4px;
      cursor: pointer;
  }
  /* fixed slider at bottom of page */
  .difficulty-control {
      position: fixed;
      bottom: 40px; /* above footer */
      left: 0;
      width: 100%;
      padding: 0 10px;
      color: #5A606A;
      font-size: 14px;
      background: rgba(40,43,51,0.9);
      display: flex;
      align-items: center;
      gap: 10px;
  }
  .difficulty-control input[type=range] {
      flex: 1;
  }
  .start-btn {
      font-size: 20px;
      padding: 12px 40px;
      background: #54F176;
      color: #282B33;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: -apple-system, Helvetica, Arial;
  }
  .start-btn:hover {
      background: #45d865;
  }
  .game-area {
      display: none;
  }
  </style>
</head>
<body>
    <div class="start-page">
        <div class="start-content">
            <h1>Sterke Werkwoorden</h1>
            <div class="list-selector">
                <label for="wordlist-select">Woordenlijst:</label>
                <select id="wordlist-select">
                    <option value="complete">Heele lijst</option>
                    <option value="watleuk">Wat leuk</option>
                </select>
            </div>
            <button class="start-btn" onclick="startGame()">Start</button>
            <!-- start page content ends here -->
        </div>
    </div>
    <div class="game-area">
    <div class="progress">
        <div id="progress-error"></div>
        <div id="progress-ok"></div>
    </div>
    <div class="row">
        <div class="item">
            <label for="txt0">Infinitief</label>
            <input type="text" id="txt0" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
        <div class="item">
            <label for="txt0">Verleden tijd enkelvoud</label>
            <input type="text" id="txt1" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
        <div class="item">
            <label for="txt0">Verleden tijd meervoud</label>
            <input type="text" id="txt2" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
        <div class="item">
            <label for="txt0">Voltooid deelwoord</label>
            <input type="text" id="txt3" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
    </div>
    <div class="meaning">
    </div>
    <div class="language-selector">
        <button id="lang-en" class="lang-btn">English</button>
        <button id="lang-de" class="lang-btn">Deutsch</button>
    </div>
    <div class="submit-with-return">⏎</div>
    <div class="footer">
        Typ "?" om het antwoord te zien. ⟨⟩ met ♡ door Antelle.
    </div>
    <!-- difficulty slider fixed to bottom -->
    <div class="difficulty-control">
        <label for="difficulty-slider">Moeilijkheid:</label>
        <span id="difficulty-value">1</span>
        <input type="range" id="difficulty-slider" min="1" max="4" value="1" />
    </div>
    </div>
</body>
</html>
