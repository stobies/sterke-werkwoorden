<!DOCTYPE html>
<html manifest="app.appcache">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="192x192" href="favicon.png">
  <link rel="icon" type="image/png" href="favicon.png" />
  <title>Sterke Werkwoorden</title>
  <script src="ow.js"></script>
  <script src="watleuk.js"></script>
  <script>
  const game = {
      // state
      ow: null,
      blanksIndices: [],
      correctThisRound: 0,
      fieldHadError: {},
      total: 0,
      totalOk: 0,
      totalError: 0,
      remaining: [],
      currentLanguage: 'en',
      difficulty: 1,              // 1 (easy) .. 4 (hard)
      AVAILABLE_LANGUAGES: ['en', 'de'],
      LANGUAGE_NAMES: {'en': 'English', 'de': 'Deutsch'},
      WORDLISTS: {
          'complete': { name: 'Heele lijst', data: OwList },
          'watleuk': { name: 'Wat leuk', data: WatLeukList }
      },

      getTranslation(obj) {
          if (typeof obj === 'string') return obj;
          if (obj[this.currentLanguage]) return obj[this.currentLanguage];
          return obj['en'] || JSON.stringify(obj);
      },

      detectBrowserLanguage() {
          const browserLang = navigator.language || navigator.userLanguage || 'en';
          const langCode = browserLang.split('-')[0].toLowerCase();
          return this.AVAILABLE_LANGUAGES.includes(langCode) ? langCode : 'en';
      },

      setLanguage(lang) {
          if (this.AVAILABLE_LANGUAGES.includes(lang)) {
              this.currentLanguage = lang;
              localStorage.language = lang;
              this.updateLanguageDisplay();
          }
      },

      updateLanguageDisplay() {
          const sel = document.getElementById('language-select');
          if (sel) sel.value = this.currentLanguage;
          if (this.ow) {
              document.querySelector('.meaning').innerHTML = this.getTranslation(this.ow[4]);
          }
      },

      next() {
          if (!this.remaining.length) {
              const row = document.querySelector('.row');
              row.innerHTML = `Done! ${this.totalOk} / ${this.total}`;
              row.classList.add('results');
              document.querySelector('.meaning').innerHTML = '';
              return;
          }
          const ix = Math.floor(Math.random() * this.remaining.length);
          this.ow = this.remaining[ix];
          this.remaining.splice(ix, 1);

          // prepare blanks
          this.blanksIndices = [];
          this.correctThisRound = 0;
          this.fieldHadError = {};
          const indices = [0,1,2,3];
          for (let i = 0; i < this.difficulty; i++) {
              const j = Math.floor(Math.random() * indices.length);
              this.blanksIndices.push(indices.splice(j,1)[0]);
          }

          this.ow.forEach((part, ix) => {
              if (ix > 3) {
                  document.querySelector('.meaning').innerHTML = this.getTranslation(part);
                  return;
              }
              const txt = document.getElementById(`txt${ix}`);
              txt.classList.remove('ok','error');
              if (this.blanksIndices.includes(ix)) {
                  txt.value = '';
                  txt.readOnly = false;
              } else {
                  txt.value = part;
                  txt.readOnly = true;
              }
              if (ix === this.blanksIndices[0]) txt.focus();
          });
      },
      onInput(e) {
          if (e.target.value.indexOf('?') >= 0) {
              this.revealAnswer(parseInt(e.target.id.replace('txt',''),10));
              return;
          }
          if (!localStorage.submitWithReturn) {
              const idx = parseInt(e.target.id.replace('txt',''),10);
              if (this.blanksIndices.includes(idx) && e.target.value === this.ow[idx]) {
                  this.markCorrect(idx);
              }
          }
      },

      onKeyDown(e) {
          if (localStorage.submitWithReturn && (e.keyCode || e.which) === 13) {
              const idx = parseInt(e.target.id.replace('txt',''),10);
              if (!this.blanksIndices.includes(idx)) return;
              const incorrect = e.target.value !== this.ow[idx];
              if (incorrect) {
                  this.fieldHadError[idx] = true;
                  const txt = document.getElementById(`txt${idx}`);
                  txt.classList.add('error');
                  setTimeout(() => txt.classList.remove('error'), 200);
              } else {
                  this.markCorrect(idx);
              }
          }
      },

      // mark a specific blank as correct and advance if all done
      markCorrect(idx) {
          const txt = document.getElementById(`txt${idx}`);
          txt.classList.add('ok');
          txt.readOnly = true;
          this.correctThisRound++;
          if (this.fieldHadError[idx]) {
              this.totalError++;
          } else {
              this.totalOk++;
          }
          this.showProgress();
          if (this.correctThisRound >= this.blanksIndices.length) {
              setTimeout(() => this.next(), 300);
          } else {
              const nextIdx = this.blanksIndices[this.correctThisRound];
              const nextTxt = document.getElementById(`txt${nextIdx}`);
              if (nextTxt) nextTxt.focus();
          }
      },

      revealAnswer(idx) {
          const txt = document.getElementById(`txt${idx}`);
          txt.classList.add('error');
          txt.value = this.ow[idx];
          txt.readOnly = true;
          this.totalError++;
          this.showProgress();
          if (this.blanksIndices.includes(idx)) {
              this.correctThisRound++;
              if (this.correctThisRound >= this.blanksIndices.length) {
                  setTimeout(() => this.next(), 1000);
              } else {
                  const nextIdx = this.blanksIndices[this.correctThisRound];
                  const nextTxt = document.getElementById(`txt${nextIdx}`);
                  if (nextTxt) nextTxt.focus();
              }
          }
      },

      showProgress() {
          document.getElementById('progress-ok').style.width = (this.totalOk / this.total * 100) + '%';
          document.getElementById('progress-error').style.width = (this.totalError / this.total * 100) + '%';
      },

      init() {
          this.currentLanguage = localStorage.language || this.detectBrowserLanguage();

          // language dropdown
          const langSel = document.getElementById('language-select');
          if (langSel) {
              langSel.value = localStorage.language || this.detectBrowserLanguage();
              langSel.addEventListener('change', (e) => this.setLanguage(e.target.value));
          }
          this.updateLanguageDisplay();

          document.querySelectorAll('input').forEach(input => {
              input.addEventListener('input', (e) => this.onInput(e));
              input.addEventListener('keydown', (e) => this.onKeyDown(e));
              input.addEventListener('focus', (e) => {
                  // make sure focused field is visible when keyboard opens
                  e.target.scrollIntoView({behavior:'smooth', block:'center'});
              });
          });

          const sel = document.getElementById('difficulty-select');
          if (sel) {
              sel.value = localStorage.difficulty || 1;
              this.difficulty = parseInt(sel.value,10);
              sel.addEventListener('change', (e) => {
                  this.difficulty = parseInt(e.target.value,10);
                  localStorage.difficulty = this.difficulty;
                  // no extra display update needed; select shows the label
              });
          }

          document.querySelectorAll('.submit-with-return').forEach(check => {
              check.addEventListener('click', () => {
                  if (localStorage.submitWithReturn) delete localStorage.submitWithReturn;
                  else localStorage.submitWithReturn = true;
                  this.showSubmitWithReturn();
              });
          });
          this.showSubmitWithReturn();

          document.getElementById('start-button').addEventListener('click', () => this.startGame());
          this.showStartPage();
      },

      showStartPage() {
          document.querySelector('.start-page').style.display = 'flex';
          document.querySelector('.game-area').style.display = 'none';
      },

      updateDifficultyDisplay() {
          const disp = document.getElementById('difficulty-value');
          if (disp) {
              const labels = ['1 (gemakkelijk)', '2', '3', '4 (moeilijk)'];
              disp.textContent = labels[this.difficulty-1] || this.difficulty;
          }
      },

      startGame() {
          const listKey = document.getElementById('wordlist-select').value;
          this.difficulty = parseInt(document.getElementById('difficulty-select').value,10) || 1;
          localStorage.difficulty = this.difficulty;
          const selected = this.WORDLISTS[listKey].data.map(item => [...item]);
          this.total = selected.length;
          this.totalOk = 0;
          this.totalError = 0;
          document.getElementById('progress-ok').style.width = '0%';
          document.getElementById('progress-error').style.width = '0%';
          document.querySelector('.start-page').style.display = 'none';
          document.querySelector('.game-area').style.display = 'block';
          this.remaining = selected;
          this.next();
      },

      showSubmitWithReturn() {
          document.querySelector('.submit-with-return').classList.toggle('active', !!localStorage.submitWithReturn);
      }
  };

  window.addEventListener('DOMContentLoaded', () => game.init());
  </script>
  <style>
  body, html {
      height: 100%;
      min-height: 100%;
  }
  body {
      font-family: -apple-system, Helvetica, Arial;
      padding: 0;
      margin: 0;
      font-size: 30px;
      background: #282B33;
  }
  .row {
      display: flex;
      justify-content: space-between;
      padding-top: 1%;
  }
  .row.results {
      color: #ABB2BE;
  }
  @media screen and (max-width: 800px) {
      .row {
          flex-direction: column;
          justify-content: flex-start;
      }
      input {
          font-size: 24px;
      }
      .item {
          padding: 8px;
      }
      .meaning {
          padding: 15px 0;
      }
  }
  .results {
      padding: 20px;
      justify-content: center;
  }
  .item {
      padding: 10px;
      position: relative;
  }
  label {
      display: block;
      padding: 2px 4px;
      font-size: 9px;
      color: #5A606A;
  }
  input {
      display: block;
      width: 90%;
      font-size: 26px;
      padding: 2px 6px;
      transition: background-color 300ms linear, border-color 300ms linear;
      outline: none;
      border-radius: 2px;
      border: 2px solid #555C66;
      background: #282B33;
      color: #ABB2BE;
  }
  input[readOnly] {
      border-color: transparent;
  }
  input.ok {
      background-color: #242E2E;
      border-color: #74C892;
  }
  input.error {
      background-color: #312426;
      border-color: #FF644E;
  }
  .progress {
      display: flex;
  }
  #progress-ok, #progress-error {
      height: 2px;
      width: 0;
      transition: width 100ms linear;
  }
  #progress-ok {
      background: #54F176;
      box-shadow: 0 0 3px #242E2E;
  }
  #progress-error {
      background: #FF644E;
      box-shadow: 0 0 3px #312426;
  }
  .meaning {
      color: #5A606A;
      text-align: center;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
  }
  .footer {
      /* improved contrast for help text */
      color: #ABB2BE;
      font-size: 12px;
      text-align: center;
      width: 100%;
      padding: 10px 0;
      /* increase opacity for readability */
      opacity: 0.6;
  }
  .submit-with-return {
      position: fixed;
      right: 10px;
      bottom: 10px;
      color: #373A43;
      font-family: monospace;
      cursor: pointer;
      font-size: 14px;
      transition: color 100ms ease-out;
  }
  .submit-with-return.active, .submit-with-return.active:hover {
      color: #555C66;
  }
  .submit-with-return:hover {
      color: #3d414b;
  }
  .language-selector {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
  }
  .lang-btn {
      padding: 6px 12px;
      background: #3d414b;
      color: #5A606A;
      border: 1px solid #555C66;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: -apple-system, Helvetica, Arial;
      transition: all 100ms ease-out;
  }
  .lang-btn:hover {
      background: #444a54;
      color: #6b7280;
  }
  .lang-btn.active {
      background: #54F176;
      color: #282B33;
      border-color: #54F176;
  }
  .start-page {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
  }
  .start-content {
      text-align: center;
  }
  .start-content h1 {
      color: #ABB2BE;
      margin-bottom: 30px;
  }
  .list-selector {
      margin-bottom: 30px;
  }
  .list-selector label {
      color: #5A606A;
      font-size: 16px;
      display: block;
      margin-bottom: 10px;
  }
  .list-selector select {
      font-size: 18px;
      padding: 10px 20px;
      background: #3d414b;
      color: #ABB2BE;
      border: 1px solid #555C66;
      border-radius: 4px;
      cursor: pointer;
  }
  /* controls container at bottom */
  .controls-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 10px 0;
  }
  .difficulty-control, .language-selector {
      color: #5A606A;
      font-size: 14px;
      background: rgba(40,43,51,0.9);
      padding: 6px 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
  }
  .difficulty-control select, .language-selector select {
      font-size: 14px;
      padding: 2px 4px;
      background: #3d414b;
      color: #ABB2BE;
      border: 1px solid #555C66;
      border-radius: 4px;
      cursor: pointer;
  }
  .start-btn {
      font-size: 20px;
      padding: 12px 40px;
      background: #54F176;
      color: #282B33;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: -apple-system, Helvetica, Arial;
  }
  .start-btn:hover {
      background: #45d865;
  }
  .game-area {
      display: none;
      height: 100vh;
      overflow: auto;
      box-sizing: border-box;
      padding-bottom: 10vh;
  }
  </style>
</head>
<body>
    <div class="start-page">
        <div class="start-content">
            <h1>Sterke Werkwoorden</h1>
            <div class="list-selector">
                <label for="wordlist-select">Woordenlijst:</label>
                <select id="wordlist-select">
                    <option value="complete">Heele lijst</option>
                    <option value="watleuk">Wat leuk</option>
                </select>
            </div>
            <button id="start-button" class="start-btn">Start</button>
            <!-- start page content ends here -->
        </div>
    </div>
    <div class="game-area">
    <div class="progress">
        <div id="progress-error"></div>
        <div id="progress-ok"></div>
    </div>
    <div class="row">
        <div class="item">
            <label for="txt0">Infinitief</label>
            <input type="text" id="txt0" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
        <div class="item">
            <label for="txt0">Verleden tijd enkelvoud</label>
            <input type="text" id="txt1" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
        <div class="item">
            <label for="txt0">Verleden tijd meervoud</label>
            <input type="text" id="txt2" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
        <div class="item">
            <label for="txt0">Voltooid deelwoord</label>
            <input type="text" id="txt3" autocomplete="off" autocapitalize="off" spellcheck="false" autocorrect="off" />
        </div>
    </div>
    <div class="meaning">
    </div>
    <!-- controls moved below main game area -->
    <div class="controls-container">
      <div class="difficulty-control">
          <label for="difficulty-select">Moeilijkheid:</label>
          <select id="difficulty-select">
              <option value="1">1 (gemakkelijk)</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4 (moeilijk)</option>
          </select>
      </div>
      <div class="language-selector">
          <label for="language-select" class="visually-hidden">Language</label>
          <select id="language-select">
              <option value="en">English</option>
              <option value="de">Deutsch</option>
          </select>
      </div>
    </div>
    <div class="submit-with-return">⏎</div>
    <div class="footer">
        Typ "?" om het antwoord te zien. ⟨⟩ met ♡ door Antelle.
    </div>
    </div>
</body>
</html>
